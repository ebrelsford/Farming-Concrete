{% extends "base.html" %}
{% load static %}

{% block breadcrumbs %}<a href="{% url "home" %}">home</a> &gt;&gt; {% endblock %}

{% block head %}
{{ block.super }}    
<script src="{% static "lib/OpenLayers/OpenLayers.js" %}" type="text/javascript"></script>
<script src="{% static "js/cloudmade.js" %}" type="text/javascript"></script>
<script src="{% static "js/map.js" %}" type="text/javascript"></script>
<script src="{% static "lib/jquery.tablesorter.min.js" %}" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function() {
    $('#map').gardenmap({
        {% block map_options %}
        initialZoom: 10,
        queryString: 'participating=yes&{% if type %}type={{ type.short_name }}&{% endif %}{% if borough %}borough={{ borough }}&{% endif %}year={{ year }}',
        {% endblock %}
    });

    $('table.sorted').tablesorter({
        widgets: ['zebra',],       
    });

    $('.tabs').tabs();

    $('.filter').change(function() {
        function buildQueryString() {
            var params = {};
            $('select.filter').each(function() {
                var selection = $(this).find(':selected').val();
                if (selection === 'all') return;
                params[$(this).attr('name')] = selection;
            });
            $('.filter[type="checkbox"]:checked').each(function() {
                params[$(this).attr('name')] = 'yes';
            });
            return params;
        }
        var params = buildQueryString();
        window.location = '/reports/{{ year }}?' + $.param(params);
    });


    // show info-box

    $('.average-yield').click(function(event) {
        if (!$(this).text()) return;
        var variety = $(this).data('crop-name');
        var year = $(this).data('year');
        $(this).addClass('picked');
        $.get('{% url "estimates_estimatedyield_explain" %}?variety=' + variety + '&year=' + year, function(data) {
            $('body').append($('<div/>')
                .html(data)
                .addClass('info-box')
                .position({
                    my: 'left top',
                    at: 'left top',
                    of: event,
                })
            );
        });
    });


    // hide info-box if anything outside of it is clicked

    $(document).click(function(event) {
        if ($(event.target).parents('.info-box').size()) return;
        if ($('.info-box').size()) {
            $('.average-yield').removeClass('picked');
            $('.info-box').remove();
        }
    });

    {% block extra_scripts %}{% endblock %}
});
</script>
{% endblock %}

{% block content %}

{% block page_title %}{% endblock %}

<div class="map-page report">
    <div id="map" style="width: 100%; height: {% if garden %}150{% else %}350{% endif %}px;"></div>

    {% if not garden %}
    <div>
        borough:
        <select class="filter" name="borough">
            <option value="all">all</option>
            {% for select_borough in boroughs %}
            <option value="{{ select_borough }}"{% if borough|lower == select_borough|lower %} selected="selected"{% endif %}>{{ select_borough }}</option>
            {% endfor %}
        </select>

        garden type:
        <select class="filter" name="type">
            <option value="all">all</option>
            {% for select_type in garden_types %}
            <option value="{{ select_type.short_name }}"{% if type.short_name == select_type.short_name %} selected="selected"{% endif %}>{{ select_type.name }}s</option>
            {% endfor %}
        </select>
    </div>
    <div>(experimental!)
        <input class="filter" type="checkbox" id="use_all_cropcount" name="use_all_cropcount" {% if use_all_cropcount %}checked="checked" {% endif %}/> <label for="use_all_cropcount"> Add previous years' cropcounts for gardens without one this year</label>
    {% endif %}

    <div class="tabs">
        <ul>
            {% if not garden %}
            <li><a href="#overall">Overall</a></li>
            {% endif %}
            <li><a href="#cropcount">Crop Count</a></li>
            <li><a href="#harvestcount">Harvest Count</a></li>
        </ul>

        {% if not garden %}
        <div id="overall">
        {% include "reports/overall.html" %}
        </div>
        {% endif %}

        <div id="cropcount">
        {% include "reports/cropcount.html" %}
        </div>

        <div id="harvestcount">
        {% include "reports/harvestcount.html" %}
        </div>

    </div>

    <div id="bottom" style="clear: both;"> </div>
</div>
{% endblock %}

{% block actions %}
{% endblock %}
