{% extends "harvestcount/gardens/base.html" %}

{% block title %}{{ garden.name }}{% endblock %}

{% block head %}
<script src="{{ MEDIA_URL }}js/OpenLayers/OpenLayers.js" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}js/cloudmade.js" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}js/jquery-util.js" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}js/map.js" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}js/help.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $('#map').gardenmap({
            type: 'single',
            id: {{ garden.id }},   
        });

        $('a.delete').click(function(event) {
            if (!confirm("Are you sure you want to delete this harvest?")) {
                return false;
            }
        });

        $('#id_harvested').datepicker({
            dateFormat: 'mm/dd/yy',
            maxDate: '+0D',
            buttonImage: '{{ MEDIA_URL }}img/calendar_1.png',
            buttonImageOnly: true,
            showOn: 'both',
        });

        $('#id_gardener_text, #id_variety_text').focusout(function() {
            var gardener = $('#id_gardener_text').val();
            var variety = $('#id_variety_text').val();
            if (gardener && gardener !== '' && variety && variety !== '') {
                $.getJSON('last_harvest?gardener=' + gardener + '&variety=' + variety, function(h) {
                    $('#id_plants').val(h.plants);   
                    $('#id_area').val(h.area);   
                });
            }
        });

        $('#gardener_help').help({ text: 'Pick the gardener who grew this.' });
        $('#variety_help').help({ text: 'Pick the type of plant.' });
        $('#weight_help').help({ text: 'Enter the weight of the harvest.' });
        $('#plants_help').help({ text: 'Enter the number of plants the harvest came from.' });
        $('#harvested_help').help({ text: 'Enter the date the harvest was taken.' });
    });   
</script>
{% endblock %}

{% block breadcrumbs %}{{ block.super }}{{ garden.name }}{% endblock %}

{% block content %}
{% if garden %}
    <h1>{{ garden.name }}</h1>

    <div id="left">
    <div id="harvests">
        <ul class="values">
            <li id="new-harvest" style="border-bottom: 2px solid black; margin-bottom: 10px;">
                <span style="font-weight: bold; margin-top: 5px;">Add a new harvest to this garden</span>
                <form method="post" action=".">
                    {% csrf_token %}
                    {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                    {% endfor %}
                    <div id="errors">
                        {{ form.non_field_errors }}
                    </div>
                    <div id="inputs">
                        <div>
                            <li>
                            {{ form.gardener.errors }}
                            <label for="id_gardener_text">{{ form.gardener.label }}:</label> {{ form.gardener }} <span id="gardener_help" class="help_link">?</span><br />
                            {{ form.variety.errors }}
                            <label for="id_variety_text">{{ form.variety.label }}:</label> {{ form.variety }} <span id="variety_help" class="help_link">?</span><br />
                            {{ form.weight.errors }}
                            <label for="id_weight">{{ form.weight.label }}:</label> {{ form.weight }} pounds <span id="weight_help" class="help_link">?</span><br />
                            {{ form.plants.errors }}{{ form.area.errors }}
                            <label for="id_plants">Plants <strong>or</strong> area:</label> {{ form.plants }} plants {{ form.area }} sq ft <span id="plants_help" class="help_link">?</span><br />
                            {{ form.harvested.errors }}
                            <label for="id_harvested">Date harvested:</label> {{ form.harvested }} <span id="harvested_help" class="help_link">?</span>
                        </div>
                        <input type="submit" value="add" />
                    </div>
                </form>
            </li>
            <li class="harvest" style="font-weight: bold; border-bottom: 1px solid black;">
                <span class="gardener">gardener</span>
                <span class="variety">plant type</span>
                <span class="weight">lbs</span>
                <span class="dimensions">quantity</span>
                <span class="harvested">date</span>
            </li>
            {% for harvest in harvests %}
            <li class="harvest {% cycle 'odd' 'even' %}">
                <span class="gardener">
                    {# link to gardener? #}
                    {{ harvest.gardener.name }}
                </span> 
                <span class="variety">
                    {{ harvest.variety.name }}
                </span>
                <span class="weight">
                    {{ harvest.weight|floatformat }}
                </span>
                <span class="dimensions">
                    {% if harvest.plants %}
                    {{ harvest.plants|floatformat }} plants{% if harvest.area %},{% endif %}
                    {% endif %}
                    
                    {% if harvest.area %}
                    {{ harvest.area|floatformat }} sq ft
                    {% endif %}
                </span>
                <span class="harvested">
                    {{ harvest.harvested|date:"n/j/y" }}
                </span>
                <span class="actions">
                    <a class="delete" href="{% url harvestcount.views.delete_harvest harvest.id %}">
                        <img src="{{ MEDIA_URL }}img/round_delete_small.png" title="remove this bed" />
                    </a>
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>
    </div>

    <div id="right">
        <div id="map" style="width: 300px; height: 200px;"></div>
        <ul class="overview">
            <li><b>{{ harvests.count|default:"0" }}</b> harvest{{ harvests.count|pluralize }}</li>
            <li><b>{{ weight|floatformat|default:"0" }}</b> pounds</li>
            <li><b>{{ plant_types|default:"0" }}</b> plant type{{ harvests.count|pluralize }}</li>
        </ul>
    </div>
{% else %}
    <p>No such garden</p>
{% endif %}
{% endblock %}

{% block actions %}
<h2>
    <a class="image" href="{% url harvestcount.views.download_garden_harvestcount_as_csv id=garden.id %}"><img src="{{ MEDIA_URL }}img/download.png" /></a>
    <a class="text" href="{% url harvestcount.views.download_garden_harvestcount_as_csv id=garden.id %}">Download this as a spreadsheet</a>
</h2>
{{ block.super }}
<h2>
    <a class="image" href="{% url harvestcount.views.index %}"><img src="{{ MEDIA_URL }}img/round_checkmark.png" /></a>
    <a class="text" href="{% url harvestcount.views.index %}">Done adding harvests to this garden!</a>
</h2>
{% endblock %}
